{% extends 'tasks/base.html' %}

{% block title %}Dashboard - EmoFocus{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-brain me-2"></i>Emotion-Aware Dashboard</h1>
            <div class="d-flex align-items-center">
                <span class="me-3">Live Data: </span>
                <span id="data-status">
                    <span class="badge bg-info">Loading...</span>
                </span>
                <button class="btn btn-sm btn-secondary ms-2" onclick="refreshDashboardData()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Comprehensive Emotion Display (from API) -->
        <div class="card mb-4" id="emotionCard" style="display:none;">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-heart me-2"></i>Comprehensive Emotional State
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <span id="current-emotion-display" class="emotion-badge">
                                <i class="fas fa-smile"></i> Neutral
                            </span>
                        </div>
                        
                        <!-- Multi-modal emotion sources -->
                        <div class="small text-muted" id="emotion-sources">
                            <div><i class="fas fa-spinner fa-spin"></i> Loading emotion data...</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Emotion trend -->
                        <div id="emotion-trend" style="display:none;">
                            <small class="text-muted">Last 24 Hours</small>
                            <div class="progress" style="height: 8px;">
                                <div id="emotion-trend-bar" class="progress-bar bg-info"></div>
                            </div>
                            <small id="emotion-trend-label">Analyzing...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Empathy Message (from API) -->
        <div class="card mb-4" id="empathyCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display:none;">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <i class="fas fa-robot fa-2x me-3"></i>
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">AI Empathy Assistant</h6>
                        <p class="mb-2" id="empathy-message">Loading your personalized message...</p>
                        <button class="btn btn-sm btn-light" onclick="refreshEmotionData()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Recommendations (from API) -->
        <div class="card mb-4" id="recommendationsCard" style="display:none;">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-lightbulb me-2"></i>Recommended Tasks
                </h5>
                <div id="recommendations-list" class="list-group list-group-flush">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Tasks (from API) -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>Current Tasks
                    </h5>
                    <a href="{% url 'create_task' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add Task
                    </a>
                </div>
                
                <div id="tasks-list">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading your tasks...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Statistics (from API) -->
        <div class="card stats-card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>Task Statistics
                </h5>
                <div class="row text-center" id="task-stats">
                    <div class="col-4">
                        <div class="h4 mb-0" id="total-tasks">-</div>
                        <small>Total</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 mb-0" id="pending-tasks">-</div>
                        <small>Pending</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 mb-0" id="completed-tasks">-</div>
                        <small>Completed</small>
                    </div>
                </div>
                <div class="mt-3" id="completion-rate" style="display:none;">
                    <small class="text-muted">Completion Rate</small>
                    <div class="progress" style="height: 8px;">
                        <div id="completion-bar" class="progress-bar bg-success"></div>
                    </div>
                    <small id="completion-percentage">0%</small>
                </div>
            </div>
        </div>

        <!-- Engagement & Level -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-star me-2"></i>Your Progress
                </h5>
                <div id="engagement-data">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Emotions (from API) -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-history me-2"></i>Recent Emotions
                </h5>
                <div id="recent-emotions-list">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
                <div class="d-grid gap-2">
                    <a href="{% url 'emotion_analytics' %}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line me-1"></i>View Analytics
                    </a>
                    <a href="{% url 'motivation_chat' %}" class="btn btn-outline-success">
                        <i class="fas fa-comments me-1"></i>AI Coaching
                    </a>
                    <button class="btn btn-outline-warning" onclick="refreshDashboardData()">
                        <i class="fas fa-sync me-1"></i>Refresh All
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Break Suggestion Modal -->
<div class="modal fade" id="breakModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Break Suggestion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="breakSuggestion"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API Service
    class DashboardAPI {
        static async fetchUserComplete() {
            try {
                const response = await fetch('/emotion_detection/api/user/complete/');
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'success' ? data.data : null;
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
            return null;
        }

        static async fetchTasksAnalytics() {
            try {
                const response = await fetch('/tasks/api/tasks/analytics/');
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'success' ? data.data : null;
                }
            } catch (error) {
                console.error('Error fetching task analytics:', error);
            }
            return null;
        }

        static async fetchTaskRecommendations() {
            try {
                const response = await fetch('/tasks/api/tasks/recommendations/');
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'success' ? data.data : null;
                }
            } catch (error) {
                console.error('Error fetching recommendations:', error);
            }
            return null;
        }

        static async fetchAllTasks(status = null) {
            try {
                const url = status ? `/tasks/api/tasks/?status=${status}` : '/tasks/api/tasks/';
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'success' ? data.data : null;
                }
            } catch (error) {
                console.error('Error fetching tasks:', error);
            }
            return null;
        }
    }

    // Update Dashboard
    async function refreshDashboardData() {
        updateDataStatus('Loading...');
        
        // Fetch all data in parallel
        const [userData, analytics, recommendations, allTasks] = await Promise.all([
            DashboardAPI.fetchUserComplete(),
            DashboardAPI.fetchTasksAnalytics(),
            DashboardAPI.fetchTaskRecommendations(),
            DashboardAPI.fetchAllTasks('pending')
        ]);

        if (userData) {
            updateEmotionDisplay(userData);
            updateEngagementDisplay(userData);
            updateRecentEmotions(userData);
        }

        if (analytics) {
            updateTaskStats(analytics);
        }

        if (allTasks) {
            updateTasksList(allTasks);
        }

        if (recommendations && recommendations.recommendations) {
            updateRecommendations(recommendations.recommendations);
        }

        updateDataStatus('Live');
    }

    function updateDataStatus(status) {
        const statusBadge = document.getElementById('data-status');
        if (statusBadge) {
            statusBadge.innerHTML = status === 'Live' 
                ? '<span class="badge bg-success">Live</span>'
                : '<span class="badge bg-info">Loading...</span>';
        }
    }

    function updateEmotionDisplay(userData) {
        const emotionCard = document.getElementById('emotionCard');
        if (!userData.emotions || !userData.emotions.current_emotion) {
            emotionCard.style.display = 'none';
            return;
        }

        emotionCard.style.display = 'block';
        const emotion = userData.emotions.current_emotion;
        const emotionIcons = {
            'happy': 'üòä', 'sad': 'üò¢', 'angry': 'üò†', 'stressed': 'üò∞',
            'calm': 'üòå', 'focused': 'üéØ', 'excited': 'üéâ', 'tired': 'üò¥'
        };

        const icon = emotionIcons[emotion.emotion] || 'üòê';
        document.getElementById('current-emotion-display').innerHTML = 
            `<i class="fas fa-heart"></i> ${icon} ${emotion.emotion.charAt(0).toUpperCase() + emotion.emotion.slice(1)}`;

        // Update empathy message
        const empathyCard = document.getElementById('empathyCard');
        if (userData.mental_health && userData.mental_health.empathetic_message) {
            empathyCard.style.display = 'block';
            document.getElementById('empathy-message').textContent = userData.mental_health.empathetic_message;
        }
    }

    function updateEngagementDisplay(userData) {
        const engagementDiv = document.getElementById('engagement-data');
        if (!userData.engagement) {
            engagementDiv.innerHTML = '<p class="text-muted">No engagement data</p>';
            return;
        }

        const eng = userData.engagement;
        let html = `
            <div class="row text-center">
                <div class="col-4">
                    <div class="h5 mb-0" style="color: #ffc107;">‚≠ê</div>
                    <small>Level ${eng.level || 1}</small>
                </div>
                <div class="col-4">
                    <div class="h5 mb-0" style="color: #28a745;">üî•</div>
                    <small>${eng.streaks?.current_streak || 0} Day Streak</small>
                </div>
                <div class="col-4">
                    <div class="h5 mb-0" style="color: #0d6efd;">‚ö°</div>
                    <small>${eng.points || 0} Points</small>
                </div>
            </div>
        `;
        if (eng.achievements && eng.achievements.length > 0) {
            html += `<div class="mt-3"><small>üèÜ ${eng.achievements.length} Achievements</small></div>`;
        }
        engagementDiv.innerHTML = html;
    }

    function updateRecentEmotions(userData) {
        const emotionsList = document.getElementById('recent-emotions-list');
        if (!userData.emotions || !userData.emotions.history_24h) {
            emotionsList.innerHTML = '<p class="text-muted">No emotion history</p>';
            return;
        }

        const emotionIcons = {
            'happy': 'üòä', 'sad': 'üò¢', 'angry': 'üò†', 'stressed': 'üò∞',
            'calm': 'üòå', 'focused': 'üéØ', 'excited': 'üéâ', 'tired': 'üò¥'
        };

        let html = '';
        userData.emotions.history_24h.slice(0, 5).forEach(e => {
            const icon = emotionIcons[e.emotion] || 'üòê';
            const time = new Date(e.timestamp).toLocaleTimeString();
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${icon} ${e.emotion.charAt(0).toUpperCase() + e.emotion.slice(1)}</span>
                    <small class="text-muted">${time}</small>
                </div>
            `;
        });
        emotionsList.innerHTML = html || '<p class="text-muted">No recent emotions</p>';
    }

    function updateTaskStats(analytics) {
        if (!analytics.overview) return;

        const overview = analytics.overview;
        document.getElementById('total-tasks').textContent = overview.total_tasks || 0;
        document.getElementById('pending-tasks').textContent = overview.pending_tasks || 0;
        document.getElementById('completed-tasks').textContent = overview.completed_tasks || 0;

        const rate = overview.completion_rate || 0;
        document.getElementById('completion-rate').style.display = 'block';
        document.getElementById('completion-bar').style.width = rate + '%';
        document.getElementById('completion-percentage').textContent = rate.toFixed(0) + '%';
    }

    function updateTasksList(tasks) {
        const tasksList = document.getElementById('tasks-list');
        if (!tasks || tasks.length === 0) {
            tasksList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No pending tasks. Create your first task!</p>
                    <a href="{% url 'create_task' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Create Task
                    </a>
                </div>
            `;
            return;
        }

        const priorityBadges = { 'high': 'danger', 'medium': 'warning', 'low': 'success' };
        let html = '';
        tasks.slice(0, 5).forEach(task => {
            const badge = priorityBadges[task.priority] || 'secondary';
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${task.title}</h6>
                                <small class="text-muted">${task.description?.substring(0, 50) || ''}</small>
                            </div>
                            <span class="badge bg-${badge}">${task.priority}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        tasksList.innerHTML = html;
    }

    function updateRecommendations(recommendations) {
        const recCard = document.getElementById('recommendationsCard');
        const recList = document.getElementById('recommendations-list');
        
        if (!recommendations || recommendations.length === 0) {
            recCard.style.display = 'none';
            return;
        }

        recCard.style.display = 'block';
        let html = '';
        recommendations.slice(0, 5).forEach((rec, idx) => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">#${idx + 1} ${rec.task_title}</h6>
                            <small class="text-muted">${rec.reason}</small>
                        </div>
                        <div class="text-end">
                            <small class="badge bg-success">${(rec.match_score * 100).toFixed(0)}% match</small>
                        </div>
                    </div>
                </div>
            `;
        });
        recList.innerHTML = html;
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        refreshDashboardData();
        // Auto-refresh every minute
        setInterval(refreshDashboardData, 60000);
    });
</script>
{% endblock %}
