{% extends 'tasks/base.html' %}

{% block title %}Task List - EmoFocus{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-tasks me-2"></i>My Tasks</h1>
    <div>
        <button class="btn btn-outline-secondary me-2" onclick="refreshTaskList()">
            <i class="fas fa-sync"></i> Refresh
        </button>
        <a href="{% url 'create_task' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Task
        </a>
    </div>
</div>

<!-- Filters (Client-side) -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="filter-status" class="form-label">Status</label>
                <select class="form-select" id="filter-status" onchange="applyFilters()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter-priority" class="form-label">Priority</label>
                <select class="form-select" id="filter-priority" onchange="applyFilters()">
                    <option value="">All Priorities</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="filter-search" class="form-label">Search Tasks</label>
                <input type="text" class="form-control" id="filter-search" placeholder="Search..." onkeyup="applyFilters()">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">Clear</button>
            </div>
        </div>
    </div>
</div>

<!-- Task Statistics (from API) -->
<div class="row mb-4" id="task-stats-row">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="total-count">0</h5>
                <small class="text-muted">Total Tasks</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="pending-count">0</h5>
                <small class="text-muted">Pending</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="inprogress-count">0</h5>
                <small class="text-muted">In Progress</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="completed-count">0</h5>
                <small class="text-muted">Completed</small>
            </div>
        </div>
    </div>
</div>

<!-- Tasks List (from API) -->
<div id="tasks-container">
    <div class="text-center py-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading your tasks...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allTasks = [];

    class TaskListAPI {
        static async fetchAllTasks() {
            try {
                const response = await fetch('/tasks/api/tasks/?limit=100');
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'success' ? data.data : [];
                }
            } catch (error) {
                console.error('Error fetching tasks:', error);
            }
            return [];
        }

        static async fetchTaskAnalytics() {
            try {
                const response = await fetch('/tasks/api/tasks/analytics/');
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'success' ? data.data : null;
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
            }
            return null;
        }
    }

    async function refreshTaskList() {
        const [tasks, analytics] = await Promise.all([
            TaskListAPI.fetchAllTasks(),
            TaskListAPI.fetchTaskAnalytics()
        ]);

        allTasks = tasks;
        updateTaskStats(analytics);
        renderTasks(tasks);
    }

    function updateTaskStats(analytics) {
        if (!analytics || !analytics.overview) return;

        const overview = analytics.overview;
        document.getElementById('total-count').textContent = overview.total_tasks || 0;
        document.getElementById('pending-count').textContent = overview.pending_tasks || 0;
        document.getElementById('inprogress-count').textContent = overview.in_progress_tasks || 0;
        document.getElementById('completed-count').textContent = overview.completed_tasks || 0;
    }

    function renderTasks(tasks) {
        const container = document.getElementById('tasks-container');
        
        if (!tasks || tasks.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No tasks found</h4>
                    <p class="text-muted">Create your first emotion-aware task!</p>
                    <a href="{% url 'create_task' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Create Your First Task
                    </a>
                </div>
            `;
            return;
        }

        const priorityColors = { 'high': 'danger', 'medium': 'warning', 'low': 'success' };
        const statusColors = { 'pending': 'secondary', 'in_progress': 'info', 'completed': 'success' };

        let html = '';
        tasks.forEach(task => {
            const priorityColor = priorityColors[task.priority] || 'secondary';
            const statusColor = statusColors[task.status] || 'secondary';
            
            html += `
                <div class="card task-card mb-3" data-status="${task.status}" data-priority="${task.priority}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <h5 class="card-title mb-0 me-3">${task.title}</h5>
                                    <span class="badge bg-${priorityColor}">${task.priority}</span>
                                    <span class="badge bg-${statusColor} ms-2">${task.status.replace('_', ' ')}</span>
                                </div>
                                
                                <p class="card-text text-muted">${task.description || 'No description'}</p>
                                
                                <div class="text-muted small">
                                    <i class="fas fa-calendar me-1"></i>Created: ${new Date(task.created_at).toLocaleDateString()}
                                    ${task.due_date ? `<span class="ms-3"><i class="fas fa-clock me-1"></i>Due: ${new Date(task.due_date).toLocaleDateString()}</span>` : ''}
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="/tasks/update/${task.id}/" class="btn btn-outline-primary">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <a href="/tasks/delete/${task.id}/" class="btn btn-outline-danger" 
                                       onclick="return confirm('Delete this task?')">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function applyFilters() {
        const status = document.getElementById('filter-status').value;
        const priority = document.getElementById('filter-priority').value;
        const search = document.getElementById('filter-search').value.toLowerCase();

        let filtered = allTasks.filter(task => {
            const matchesStatus = !status || task.status === status;
            const matchesPriority = !priority || task.priority === priority;
            const matchesSearch = !search || task.title.toLowerCase().includes(search);
            return matchesStatus && matchesPriority && matchesSearch;
        });

        renderTasks(filtered);
    }

    function clearFilters() {
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-priority').value = '';
        document.getElementById('filter-search').value = '';
        renderTasks(allTasks);
    }

    // Load tasks on page load
    document.addEventListener('DOMContentLoaded', function() {
        refreshTaskList();
        // Auto-refresh every 2 minutes
        setInterval(refreshTaskList, 120000);
    });
</script>
{% endblock %}
