{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h2>Insights</h2>
  <div class="row">
    <div class="col-md-8">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <label for="categoryFilter">Filter:</label>
          <select id="categoryFilter" class="form-select d-inline-block" style="width:auto;">
            <option value="">All</option>
            <option value="mood_trend" {% if selected_category=='mood_trend' %}selected{% endif %}>Mood Trend</option>
            <option value="effectiveness" {% if selected_category=='effectiveness' %}selected{% endif %}>Effectiveness</option>
            <option value="pattern" {% if selected_category=='pattern' %}selected{% endif %}>Pattern</option>
            <option value="correlation" {% if selected_category=='correlation' %}selected{% endif %}>Correlation</option>
            <option value="recommendation" {% if selected_category=='recommendation' %}selected{% endif %}>Recommendation</option>
          </select>
        </div>
        <div>
          <a href="#" class="btn btn-sm btn-outline-secondary" id="downloadSelection">Export Selected</a>
        </div>
      </div>

      <div class="list-group mt-3" id="insightList">
        {% for insight in insights %}
          <a href="{% url 'insight_detail' insight.id %}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">{{ insight.title }}</h5>
              <small>{{ insight.period_end }}</small>
            </div>
            <p class="mb-1">{{ insight.description|truncatechars:140 }}</p>
            <small>Confidence: {{ insight.confidence }}</small>
          </a>
        {% empty %}
          <div class="list-group-item">No insights yet. Check back later.</div>
        {% endfor %}
      </div>
    </div>

    <div class="col-md-4">
      <h5>Summary</h5>
      <canvas id="insightsChart" width="300" height="300"></canvas>
      <div class="mt-3">
        <small class="text-muted">Tip: use the filter above to focus the chart.</small>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const counts = {{ category_counts_json|default:'{}'|safe }};
    const labels = Object.keys(counts);
    const data = labels.map(l => counts[l]);

    const ctx = document.getElementById('insightsChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{ data: data, backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f'] }]
      }
    });

    const filter = document.getElementById('categoryFilter');
    if(filter){
      filter.addEventListener('change', function(e){
        const val = e.target.value;
        const params = new URLSearchParams(window.location.search);
        if(val) params.set('category', val); else params.delete('category');
        window.location.search = params.toString();
      });
    }
  })();
</script>
{% endblock %}
